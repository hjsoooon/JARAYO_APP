// ë™í™” ì¼ê¸° ìƒì„± ì„œë¹„ìŠ¤

// ë™í™”ì˜ ì‹œì‘ ë¬¸ì¥ í…œí”Œë¦¿
const storyBeginnings = [
  (name: string) => `ì˜¤ëŠ˜ë„ ì‘ì€ ì„¸ê³„ì˜ ì£¼ì¸ê³µ ${name}ì˜ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆì–´ìš”.`,
  (name: string) => `í–‡ì‚´ì´ ì°½ë¬¸ ë„ˆë¨¸ë¡œ ì‚´ë©°ì‹œ ë“¤ì–´ì˜¤ë˜ ì•„ì¹¨, ${name}ì˜ íŠ¹ë³„í•œ í•˜ë£¨ê°€ í¼ì³ì¡Œë‹µë‹ˆë‹¤.`,
  (name: string) => `êµ¬ë¦„ ë‚˜ë¼ì—ì„œ ì˜¨ ì‘ì€ ì²œì‚¬ ${name}! ì˜¤ëŠ˜ì€ ì–´ë–¤ ëª¨í—˜ì„ í–ˆì„ê¹Œìš”?`,
  (name: string) => `ë°˜ì§ë°˜ì§ ë¹›ë‚˜ëŠ” ë³„ì²˜ëŸ¼ ì˜ˆìœ ìš°ë¦¬ ${name}ì˜ í•˜ë£¨ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦´ê²Œìš”.`,
  (name: string) => `ì‘ì€ ì™•ìë‹˜ ${name}, ì˜¤ëŠ˜ë„ ì—„ë§ˆ ì•„ë¹ ì™€ í•¨ê»˜ ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆì–´ìš”.`,
];

// ë™í™”ì˜ ë§ˆë¬´ë¦¬ ë¬¸ì¥ í…œí”Œë¦¿
const storyEndings = [
  (name: string) => `\n\nê·¸ë ‡ê²Œ ${name}ì˜ ì˜¤ëŠ˜ í•˜ë£¨ë„ ë”°ëœ»í•œ ì‚¬ë‘ìœ¼ë¡œ ê°€ë“ ì±„ì›Œì¡Œë‹µë‹ˆë‹¤. ë‚´ì¼ì€ ë˜ ì–´ë–¤ í–‰ë³µí•œ ìˆœê°„ë“¤ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”? ğŸ’«`,
  (name: string) => `\n\nì—„ë§ˆ ì•„ë¹ ì˜ í’ˆì—ì„œ ${name}ëŠ” ì˜¤ëŠ˜ë„ ì„¸ìƒì—ì„œ ê°€ì¥ í–‰ë³µí•œ ì•„ê¸°ëë‹ˆë‹¤. ì¢‹ì€ ê¿ˆ ê¿”ìš”, ìš°ë¦¬ ${name}! âœ¨`,
  (name: string) => `\n\në³„ë“¤ì´ ë°˜ì§ì´ëŠ” ë°¤, ${name}ëŠ” ë”°ëœ»í•œ ì‚¬ë‘ì— ê°ì‹¸ì—¬ ìƒˆê·¼ìƒˆê·¼ ì ì´ ë“¤ì—ˆì–´ìš”. ì‚¬ë‘í•´, ${name}! ğŸŒ™`,
  (name: string) => `\n\nì´ë ‡ê²Œ ${name}ì˜ ì†Œì¤‘í•œ í•˜ë£¨ê°€ ì§€ë‚˜ê°”ì–´ìš”. ë§¤ì¼ë§¤ì¼ì´ ê¸°ì  ê°™ì€ ìš°ë¦¬ ${name}ì˜ ì´ì•¼ê¸°ëŠ” ê³„ì†ë©ë‹ˆë‹¤. ğŸŒŸ`,
  (name: string) => `\n\nì˜¤ëŠ˜ë„ ${name}ëŠ” ì—„ë§ˆ ì•„ë¹ ì—ê²Œ ê°€ì¥ í° í–‰ë³µì„ ì„ ë¬¼í•´ì£¼ì—ˆë‹µë‹ˆë‹¤. ì‚¬ë‘í•´ìš”, ìš°ë¦¬ ì‘ì€ ì²œì‚¬ ${name}! ğŸ’•`,
];

// ë™í™” ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
const transformToStory = (name: string, userInput: string, phrContext: string): string => {
  // ë™í™” ì‹œì‘
  const beginning = storyBeginnings[Math.floor(Math.random() * storyBeginnings.length)](name);
  
  // ì‚¬ìš©ì ì…ë ¥ì„ ë™í™” ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜
  let mainStory = userInput;
  
  // "ìš°ë¦¬ ì•„ê¸°", "ì•„ê¸°", "ì• ê¸°" ë“±ì„ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
  mainStory = mainStory
    .replace(/ìš°ë¦¬\s*ì•„ê¸°|ìš°ë¦¬\s*ì• ê¸°/gi, `ìš°ë¦¬ ${name}`)
    .replace(/(\s|^)ì•„ê¸°(\s|,|\.|\!|\?|$)/gi, `$1${name}$2`)
    .replace(/(\s|^)ì• ê¸°(\s|,|\.|\!|\?|$)/gi, `$1${name}$2`);
  
  // ë™í™”ì²´ë¡œ ë¬¸ì¥ ë³€í™˜
  mainStory = mainStory
    .replace(/í–ˆì–´ìš”?\.|í–ˆì–´\.|í–ˆë‹¤\./gi, 'í–ˆë‹µë‹ˆë‹¤.')
    .replace(/í–ˆì–´ìš”?\!|í–ˆì–´\!/gi, 'í–ˆì–´ìš”!')
    .replace(/ë¨¹ì—ˆì–´ìš”?\.|ë¨¹ì—ˆì–´\./gi, 'ë¨¹ì—ˆë‹µë‹ˆë‹¤.')
    .replace(/ë†€ì•˜ì–´ìš”?\.|ë†€ì•˜ì–´\./gi, 'ë†€ì•˜ì–´ìš”.')
    .replace(/ì¤ì–´ìš”?\.|ì¤ì–´\./gi, 'ì¤ë‹µë‹ˆë‹¤.')
    .replace(/í–ˆë„¤ìš”?\.|í–ˆë„¤\./gi, 'í–ˆì–´ìš”.')
    .replace(/ì´ì—ìš”|ì˜ˆìš”/gi, 'ëë‹ˆë‹¤')
    .replace(/~|ã…‹|ã…/g, '');
  
  // PHR ê¸°ë¡ ê¸°ë°˜ ì„¸ë¶€ ë‚´ìš© ì¶”ê°€
  let phrStory = '';
  if (phrContext) {
    if (phrContext.includes('SLEEP')) {
      phrStory += ` í¬ê·¼í•œ ì´ë¶ˆ ì†ì—ì„œ ${name}ëŠ” ë‹¬ì½¤í•œ ê¿ˆë‚˜ë¼ë¡œ ë– ë‚¬ì–´ìš”.`;
    }
    if (phrContext.includes('FEED')) {
      phrStory += ` ë§›ìˆëŠ” ìš°ìœ ë¥¼ ë¨¹ê³  í˜ì´ ë¶ˆëˆ ì†Ÿì€ ${name}!`;
    }
    if (phrContext.includes('POOP')) {
      phrStory += ` ê¹¨ë—í•˜ê²Œ ì”»ê³  ìƒì¾Œí•´ì§„ ${name}ëŠ” ë”ìš± ê¸°ë¶„ì´ ì¢‹ì•„ì¡Œì–´ìš”.`;
    }
    if (phrContext.includes('BATH')) {
      phrStory += ` ëª©ìš• ì‹œê°„ì—ëŠ” ì²¨ë²™ì²¨ë²™ ë¬¼ë†€ì´ë¥¼ ì¦ê¸°ë©° ì‹ ë‚˜ê²Œ ë†€ì•˜ë‹µë‹ˆë‹¤.`;
    }
  }
  
  // ë™í™” ë§ˆë¬´ë¦¬
  const ending = storyEndings[Math.floor(Math.random() * storyEndings.length)](name);
  
  // ì „ì²´ ë™í™” ì¡°í•©
  return `${beginning}\n\n${mainStory}${phrStory}${ending}`;
};

export const generateDiaryEntry = async (
  childName: string, 
  userResponse: string, 
  phrSummary: string
): Promise<string> => {
  // ìƒì„± ì¤‘ì¸ ëŠë‚Œì„ ì£¼ê¸° ìœ„í•œ ë”œë ˆì´
  await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));

  // ì‚¬ìš©ì ì…ë ¥ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ê¸°ë³¸ ë™í™” ì œê³µ
  if (!userResponse || userResponse.trim().length < 10) {
    const fallbackStories = [
      `ì˜¤ëŠ˜ ${childName}ëŠ” ì—„ë§ˆ ì•„ë¹ ì™€ í–‰ë³µí•œ í•˜ë£¨ë¥¼ ë³´ëƒˆì–´ìš”. ë”°ëœ»í•œ í–‡ì‚´ ì•„ë˜ì—ì„œ ë°©ê¸‹ë°©ê¸‹ ì›ƒìœ¼ë©°, ì‘ì€ ì†ì„ ê¼¼ì§€ë½ê±°ë¦¬ê³ , ê·€ì—¬ìš´ ì†Œë¦¬ë¡œ ì˜¹ì•Œì´ë¥¼ í–ˆë‹µë‹ˆë‹¤.\n\nì—„ë§ˆê°€ ì•ˆì•„ì£¼ë©´ ${childName}ëŠ” ì„¸ìƒì—ì„œ ê°€ì¥ ì•ˆì „í•˜ê³  í–‰ë³µí•œ ê¸°ë¶„ì´ ë“¤ì–´ìš”. ì•„ë¹ ì˜ ëª©ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë©´ ê¹Œë¥´ë¥´ ì›ƒìŒì´ í„°ì ¸ ë‚˜ì˜¤ì£ .\n\nì˜¤ëŠ˜ë„ ${childName}ëŠ” ì‚¬ë‘ìœ¼ë¡œ ê°€ë“í•œ í•˜ë£¨ë¥¼ ë³´ëƒˆë‹µë‹ˆë‹¤. ìš°ë¦¬ì˜ ì‘ì€ ì²œì‚¬ ${childName}, ì–¸ì œë‚˜ ì‚¬ë‘í•´ìš”! ğŸ’•`,
      
      `ì‘ì€ ì™•ìë‹˜ ${childName}ì˜ íŠ¹ë³„í•œ í•˜ë£¨! ì˜¤ëŠ˜ ${childName}ëŠ” ë§ì€ ê²ƒë“¤ì„ ë°°ìš°ê³  ëŠê¼ˆì–´ìš”. ì—„ë§ˆì˜ ë”°ëœ»í•œ ì†ê¸¸, ì•„ë¹ ì˜ ë‹¤ì •í•œ ëª©ì†Œë¦¬, ì°½ë°–ìœ¼ë¡œ ë“¤ë ¤ì˜¤ëŠ” ìƒˆë“¤ì˜ ë…¸ë˜...\n\n${childName}ì˜ ëˆˆì— ë¹„ì¹œ ì„¸ìƒì€ ì°¸ ì‹ ê¸°í•˜ê³  ì•„ë¦„ë‹¤ì›Œìš”. ì‘ì€ ì†ê°€ë½ìœ¼ë¡œ ì„¸ìƒì„ íƒí—˜í•˜ê³ , í˜¸ê¸°ì‹¬ ê°€ë“í•œ ëˆˆìœ¼ë¡œ ì£¼ë³€ì„ ë°”ë¼ë³´ëŠ” ${childName}.\n\nê·¸ë ‡ê²Œ ${childName}ì˜ í•˜ë£¨ëŠ” ì‘ì€ ê¸°ì ë“¤ë¡œ ê°€ë“ ì±„ì›Œì¡Œë‹µë‹ˆë‹¤. ë‚´ì¼ì€ ë˜ ì–´ë–¤ ë©‹ì§„ ì¼ë“¤ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”? ğŸŒŸ`,
    ];
    return fallbackStories[Math.floor(Math.random() * fallbackStories.length)];
  }
  
  // ì‚¬ìš©ì ì…ë ¥ì„ ë™í™”ë¡œ ë³€í™˜
  return transformToStory(childName, userResponse, phrSummary);
};
